import streamlit as st
import os
import tempfile
import pandas as pd
from datetime import datetime
import logging

from streamlit_utilit import *

def validate_inputs(name, file1):
    """Validate user inputs before processing"""
    if not name.strip():
        st.error("Please enter a valid patient name")
        return False
    if not file1:
        st.error("Please upload metabolomic data file")
        return False
    return True

def display_group_cards(risk_params_df, risk_scores):
    # Group by risk group first
    grouped = risk_params_df.groupby('–ì—Ä—É–ø–ø–∞_—Ä–∏—Å–∫–∞')
    
    for group_name, group_df in grouped:
        # Get unique categories within this risk group
        categories = group_df[['–ö–∞—Ç–µ–≥–æ—Ä–∏—è', 'Subgroup_score']].drop_duplicates()
        
        # Calculate average score for the risk group header
        group_score = risk_scores['–†–∏—Å–∫-—Å–∫–æ—Ä'][risk_scores['–ì—Ä—É–ø–ø–∞ —Ä–∏—Å–∫–∞'] == group_name].mean()
        group_color = get_color_under_normal_dist(100 - group_score *10)
        
        # Display risk group header
        st.markdown(f"""
        <div style="
            border-left: 5px solid {group_color};
            padding: 10px;
            margin: 10px 0 5px 0;
            background-color: #f0f2f6;
            border-radius: 5px;
            font-weight: bold;
        ">
            <div style="display: flex; justify-content: space-between;">
                <span>{group_name}</span>
                <span>–ë–∞–ª–ª: {group_score:.0f}/10</span>
            </div>
        </div>
        """, unsafe_allow_html=True)
        
        # Display each category under this risk group
        for _, row in categories.iterrows():
            score = row['Subgroup_score']
            color = get_color_under_normal_dist(score)
            
            st.markdown(f"""
            <div style="
                border-left: 3px solid {color};
                padding: 8px;
                margin: 2px 0 2px 15px;
                background-color: #f8f9fa;
                border-radius: 3px;
            ">
                <div style="display: flex; justify-content: space-between;">
                    <span>{row['–ö–∞—Ç–µ–≥–æ—Ä–∏—è']}</span>
                    <span>{score:.1f}%</span>
                </div>
                <div style="
                    height: 6px;
                    background: #e9ecef;
                    margin-top: 5px;
                    border-radius: 3px;
                ">
                    <div style="
                        width: {100 - score}%;
                        height: 100%;
                        background-color: {color};
                        border-radius: 3px;
                    "></div>
                </div>
            </div>
            """, unsafe_allow_html=True)

def main():
    st.set_page_config(
        page_title="–û—Ç—á–µ—Ç Metaboscan",
        page_icon="üè•",
        layout="wide",
        initial_sidebar_state="collapsed"
    )

    # Apply smaller font sizes via custom CSS
    st.markdown("""
        <style>
            body {
                font-size: 14px !important;
            }
            .stTextInput input, .stNumberInput input, .stSelectbox select, .stDateInput input {
                font-size: 14px !important;
            }
            .stDataFrame {
                font-size: 14px !important;
            }
            .stButton button {
                font-size: 14px !important;
            }
        </style>
    """, unsafe_allow_html=True)

    # Path to the reference file
    REF_FILE = "Ref.xlsx"
    
    # Create two columns
    col1, col2 = st.columns([1, 1])
    
    with col1:
        with st.form("report_form"):
            st.write("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞—Ü–∏–µ–Ω—Ç–µ")
            
            cols = st.columns(4)
            with cols[0]:
                name = st.text_input("–ü–æ–ª–Ω–æ–µ –∏–º—è (–§–ò–û)", placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á")
            with cols[1]:
                age = st.number_input("–í–æ–∑—Ä–∞—Å—Ç", min_value=0, max_value=120, value=47)
            with cols[2]:
                gender = st.selectbox("–ü–æ–ª", ("–ú", "–ñ"), index=0)
            with cols[3]:
                date = st.date_input("–î–∞—Ç–∞ –æ—Ç—á–µ—Ç–∞", datetime.now(), format="DD.MM.YYYY")
            
            st.write("–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ")
            
            metabolomic_data = st.file_uploader(
                "–ú–µ—Ç–∞–±–æ–ª–æ–º–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –ø–∞—Ü–∏–µ–Ω—Ç–∞ (Excel)",
                type=["xlsx", "xls"],
                key="metabolomic_data"
            )
            
            submitted = st.form_submit_button("–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç", type="primary")
    
    with col2:
        st.write("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤")
        
        if os.path.exists(REF_FILE):
            try:
                # Initialize session state for both original and edited data
                if 'original_ref' not in st.session_state or 'edited_ref' not in st.session_state:
                    xls = pd.ExcelFile(REF_FILE)
                    st.session_state.original_ref = {
                        sheet_name: xls.parse(sheet_name) 
                        for sheet_name in xls.sheet_names
                    }
                    st.session_state.edited_ref = {
                        sheet_name: df.copy() 
                        for sheet_name, df in st.session_state.original_ref.items()
                    }
                
                # Create tabs for each sheet
                tabs = st.tabs(st.session_state.edited_ref.keys())
                
                for tab, (sheet_name, df) in zip(tabs, st.session_state.edited_ref.items()):
                    with tab:
                        edited_df = st.data_editor(
                            df,
                            num_rows="dynamic",
                            use_container_width=True,
                            height=300,
                            key=f"editor_{sheet_name}"
                        )
                        st.session_state.edited_ref[sheet_name] = edited_df
                
                if st.button("–°–±—Ä–æ—Å–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è", key="reset_button"):
                    st.session_state.edited_ref = {
                        sheet_name: df.copy() 
                        for sheet_name, df in st.session_state.original_ref.items()
                    }
                    st.rerun()
                
            except Exception as e:
                st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤: {str(e)}")
        else:
            st.error(f"–§–∞–π–ª –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω: {REF_FILE}")
            st.session_state.edited_ref = None
    
    if submitted:
        if validate_inputs(name, metabolomic_data):
            if not os.path.exists(REF_FILE):
                st.error("Reference file not found. Cannot proceed without Ref.xlsx")
                return
                
            if 'edited_ref' not in st.session_state:
                st.error("Reference data not loaded")
                return

            required_sheets = ['Params_metaboscan', 'Ref_stats']
            for sheet in required_sheets:
                if sheet not in st.session_state.edited_ref:
                    st.error(f"Required sheet '{sheet}' not found in reference file")
                    return

            with st.spinner("üî¨ –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç. –≠—Ç–æ –∑–∞–π–º–µ—Ç –Ω–µ –±–æ–ª—å—à–µ –º–∏–Ω—É—Ç—ã..."):
                with tempfile.TemporaryDirectory() as temp_dir:
                    try:
                        # Save Params_metaboscan sheet as temporary file
                        risk_params_path = os.path.join(temp_dir, "risk_params.xlsx")
                        st.session_state.edited_ref['Params_metaboscan'].to_excel(risk_params_path, index=False)

                        # Save Ref_stats sheet as temporary file
                        ref_stats_path = os.path.join(temp_dir, "Ref_stats.xlsx")
                        st.session_state.edited_ref['Ref_stats'].to_excel(ref_stats_path, index=False)

                        # Process data
                        metabolomic_data_with_ratios = calculate_metabolite_ratios(metabolomic_data)
                        metabolomic_data_with_ratios_path = os.path.join(temp_dir, "metabolomic_data.xlsx")
                        metabolomic_data_with_ratios.to_excel(metabolomic_data_with_ratios_path, index=False)
                        
                        # Check if input file contains multiple patients (more than 1 row after header)
                        df_metabolomic = pd.read_excel(metabolomic_data)
                        multiple_patients = len(df_metabolomic) > 1
                        
                        if multiple_patients:
                            st.info("–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤. –ü–æ–∫–∞–∑–∞–Ω—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤.")
                            st.warning("–î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∂–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –æ–¥–Ω–æ–º—É –ø–∞—Ü–∏–µ–Ω—Ç—É –∑–∞ —Ä–∞–∑.")
                            
                            # Get patient identifiers and groups from file
                            patient_ids = df_metabolomic.get('–ö–æ–¥', [f"–ü–∞—Ü–∏–µ–Ω—Ç {i+1}" for i in range(len(df_metabolomic))])
                            patient_groups = df_metabolomic.get('–ì—Ä—É–ø–ø–∞', ["-" for _ in range(len(df_metabolomic))])
                            
                            # Create tabs for each patient
                            tabs = st.tabs([f"–ü–∞—Ü–∏–µ–Ω—Ç {i+1}" for i in range(len(patient_ids))])
                            
                            for idx, tab in enumerate(tabs):
                                with tab:
                                    with st.spinner(f"–†–∞—Å—á–µ—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –¥–ª—è –ø–∞—Ü–∏–µ–Ω—Ç–∞ {idx+1}/{len(patient_ids)}..."):
                                        # Get individual patient data
                                        patient_data = metabolomic_data_with_ratios.iloc[[idx]]
                                        patient_data_path = os.path.join(temp_dir, f"patient_data_{idx}.xlsx")
                                        patient_data.to_excel(patient_data_path, index=False)
                                        
                                        # Calculate risk parameters for this patient only
                                        patient_risk_params_exp = prepare_final_dataframe_zscore(risk_params_path, patient_data_path, ref_stats_path)
                                        patient_risk_params_exp_old = prepare_final_dataframe_old(risk_params_path, patient_data_path)
                                        
                                        
                                        # Calculate risk scores for this patient only
                                        patient_risk_scores = calculate_risks(patient_risk_params_exp, patient_data)
                                        patient_risk_scores_old = calculate_risks(patient_risk_params_exp_old, patient_data)
                                        # Display results
                                        col1, col2, col3 = st.columns([1, 2, 2])
                                        
                                        with col1:
                                            st.markdown(f"**–ö–æ–¥ –ø–∞—Ü–∏–µ–Ω—Ç–∞:** {patient_ids[idx]}")
                                            st.markdown(f"**–ì—Ä—É–ø–ø–∞:** {patient_groups[idx]}")
                                            st.markdown("---")
                                        
                                        with col2:
                                            st.markdown("**C—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥:**")
                                            with st.expander("–ö–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç –≤ –æ—Ç—á–µ—Ç–µ:"):
                                                display_group_cards(patient_risk_params_exp_old, patient_risk_scores_old)
                                            st.dataframe(
                                                patient_risk_scores_old,
                                                use_container_width=True
                                            )
                                            st.dataframe(patient_risk_params_exp_old[['–ö–∞—Ç–µ–≥–æ—Ä–∏—è', 'Subgroup_score']])
                                        
                                        with col3:
                                            # Display individual risk scores
                                            st.markdown("**Z-scores:**")
                                            with st.expander("–ö–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç –≤ –æ—Ç—á–µ—Ç–µ:"):
                                                display_group_cards(patient_risk_params_exp, patient_risk_scores)
                                            st.dataframe( 
                                                patient_risk_scores,
                                                use_container_width=True
                                            )
                                            st.dataframe(
                                                patient_risk_params_exp,
                                                use_container_width=True
                                            )
                                        

                        else:  # Single patient case (original behavior)
                            risk_params_exp_zscore = prepare_final_dataframe_zscore(risk_params_path, metabolomic_data_with_ratios_path, ref_stats_path)
                            risk_params_exp_old = prepare_final_dataframe_old(risk_params_path, metabolomic_data_with_ratios_path)
                            risk_params_exp_path = os.path.join(temp_dir, "risk_exp_params.xlsx")
                            risk_params_exp_old_path = os.path.join(temp_dir, "risk_exp_params_old.xlsx")
                            risk_params_exp_zscore.to_excel(risk_params_exp_path, index=False)
                            risk_params_exp_old.to_excel(risk_params_exp_old_path, index=False)
                                
                            risk_scores = calculate_risks(risk_params_exp_zscore, metabolomic_data_with_ratios)
                            risk_scores_path = os.path.join(temp_dir, "risk_scores.xlsx")
                            risk_scores.to_excel(risk_scores_path, index=False)
                            
                            risk_scores_old = calculate_risks(risk_params_exp_old, metabolomic_data_with_ratios)
                            risk_scores_old_path = os.path.join(temp_dir, "risk_scores_old.xlsx")
                            risk_scores_old.to_excel(risk_scores_old_path, index=False)
                            
                            metrics_path = os.path.join(temp_dir, "metrics.xlsx")
                            st.session_state.edited_ref['metrics_ml_models'].to_excel(metrics_path, index=False)
                            st.info("‚úÖ –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π!")
                            cols = st.columns(2)
                            with cols[0]:
                                st.header("–°—Ç–∞—Ä—ã–µ —Ä–∏—Å–∫–∏:")
                                with st.expander("–ö–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç –≤ –æ—Ç—á–µ—Ç–µ:"):
                                    display_group_cards(risk_params_exp_old, risk_scores_old)
                                st.dataframe(risk_scores_old)
                                st.dataframe(risk_params_exp_old[['–ö–∞—Ç–µ–≥–æ—Ä–∏—è', 'Subgroup_score']])
                                
                            with cols[1]:
                                st.header("Z-score:")
                                with st.expander("–ö–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç –≤ –æ—Ç—á–µ—Ç–µ:"):
                                    display_group_cards(risk_params_exp_zscore, risk_scores)
                                st.dataframe(risk_scores)
                                st.dataframe(risk_params_exp_zscore[['–ö–∞—Ç–µ–≥–æ—Ä–∏—è','Z_score', 'Subgroup_score']])
                                
                    except Exception as e:
                        st.error(f"An error occurred: {str(e)}")
                        logging.error(f"Error in report generation: {str(e)}")

if __name__ == "__main__":
    main()